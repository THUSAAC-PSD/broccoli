name: Scheduled Security Audit

on:
  schedule:
    - cron: "0 0 * * 1" # Every Monday 00:00 UTC (08:00 UTC+8)
  workflow_dispatch: # Manual trigger

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable # cargo-audit parses Cargo.lock, never compiles; no nightly needed

      - name: Install cargo-audit
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Rust audit
        run: cargo audit # Fails on any RUSTSEC advisory; Rust CVEs are actionable

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install JS dependencies
        run: pnpm install --frozen-lockfile

      - name: JS audit (advisory only)
        run: pnpm audit --prod # --prod skips devDeps since they're not deployed, so not exploitable
        continue-on-error: true # JS audit is high-noise; visible but not a blocker

      - name: Trivy secret scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          scanners: secret
          exit-code: "0" # TODO: flip to 1 after baseline is clean
          format: table
